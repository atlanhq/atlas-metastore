
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

name: Java CI with Maven

on:
  push:
    branches:
      - alpha
      - beta
      - development
      - master
      - staging
      - tagscanary
      - tagscanarymerge
      - fixlabels
      - interceptapis
      - tags_intg_test
      - nb_tags_intg_test
      - prove-ci-blind-fresh


jobs:
  build:

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      # Set up Docker
      - name: Set up Docker
        uses: docker/setup-buildx-action@v2
        with:
          driver-opts: image=moby/buildkit:master
          install: true

      - name: Set up JDK 17
        uses: actions/setup-java@v1
        with:
          java-version: 17

      - name: Print JDK version
        run: java -version

      # Verify Docker is available
      - name: Verify Docker
        run: |
         docker --version
         docker info

      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/build.sh') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Get branch name
        run: |
          echo "BRANCH_NAME=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV
          echo BRANCH_NAME=${GITHUB_REF#refs/heads/}

      - name: Create Maven Settings
        uses: s4u/maven-settings-action@v2.8.0
        with:
          servers: |
            [{
                "id": "github",
                "username": "atlan-ci",
                "password": "${{ secrets.ORG_PAT_GITHUB }}"
            }]

      - name: Build with Maven
        run: |
          echo "build without dashboard"
          chmod +x ./build.sh && ./build.sh

      - name: Run Integration Tests
        id: integration_tests
        continue-on-error: true
        env:
          # Configure Testcontainers for GitHub Actions
          TESTCONTAINERS_RYUK_DISABLED: true
          TESTCONTAINERS_CHECKS_DISABLE: true
          DOCKER_HOST: unix:///var/run/docker.sock
        run: |
          echo "Running integration tests..."
          chmod +x ./run-integration-tests.sh && ./run-integration-tests.sh
      
      - name: Capture container logs and state on failure
        if: steps.integration_tests.outcome == 'failure'
        run: |
          echo "=========================================="
          echo "CAPTURING CONTAINER STATE FOR DEBUGGING"
          echo "=========================================="
          
          mkdir -p test-debug-logs
          
          echo "All containers (including stopped):"
          docker ps -a | tee test-debug-logs/docker-ps.log
          
          echo ""
          echo "Capturing logs from all containers..."
          
          # Get all container IDs (including stopped ones)
          for container in $(docker ps -a --format '{{.Names}}'); do
            echo "Capturing logs for: $container"
            docker logs "$container" > "test-debug-logs/${container}.log" 2>&1 || echo "Failed to get logs for $container"
          done
          
          echo ""
          echo "Checking for test-related containers..."
          docker ps -a --filter "name=test" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          
          echo ""
          echo "Disk space:"
          df -h
          
          echo ""
          echo "=========================================="
          echo "Logs saved to test-debug-logs/ directory"
          echo "Containers are still available (stopped but not removed)"
          echo "=========================================="
          
          ls -lh test-debug-logs/
          
          echo ""
          echo "=========================================="
          echo "PREVENTING CONTAINER CLEANUP"
          echo "=========================================="
          # Docker containers should NOT be auto-removed (Ryuk is disabled)
          # But let's verify and show container states
          
          echo "Container states:"
          docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Image}}\t{{.Ports}}"
          
          echo ""
          echo "If you SSH in via tmate, these containers will still be available:"
          echo "  - Use: docker ps -a"
          echo "  - Use: docker logs <container-name>"
          echo "  - Use: docker inspect <container-name>"
          echo "  - Use: docker exec <container-name> <command>"
          echo ""
          echo "Logs are also saved in test-debug-logs/ for offline inspection"
          echo "=========================================="
          
          echo ""
          echo "=========================================="
          echo "PREVIEW: Atlas Container Logs (last 100 lines)"
          echo "=========================================="
          # Find and show Atlas container logs immediately
          atlas_container=$(docker ps -a --filter "ancestor=atlanhq/atlas:test" --format "{{.Names}}" | head -1)
          if [ -n "$atlas_container" ]; then
            echo "Atlas container: $atlas_container"
            docker logs "$atlas_container" 2>&1 | tail -100 || echo "No Atlas logs available"
          else
            echo "No Atlas container found"
          fi
          
          echo ""
          echo "=========================================="
          echo "PREVIEW: Redis Sentinel Logs (last 50 lines)"
          echo "=========================================="
          sentinel_container=$(docker ps -a --filter "ancestor=redis:6.2.14" --filter "name=sentinel" --format "{{.Names}}" | head -1)
          if [ -n "$sentinel_container" ]; then
            echo "Sentinel container: $sentinel_container"
            docker logs "$sentinel_container" 2>&1 | tail -50 || echo "No Sentinel logs available"
          else
            echo "No Sentinel container found"
          fi
          
          echo ""
          echo "=========================================="
          echo "Full logs available in artifacts and via tmate SSH"
          echo "=========================================="
      
      - name: Upload container logs as artifact
        if: steps.integration_tests.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: container-logs-${{ github.run_id }}
          path: test-debug-logs/
          retention-days: 5
      
      - name: Setup tmate session on test failure
        if: steps.integration_tests.outcome == 'failure'
        uses: mxschmitt/action-tmate@v3
        timeout-minutes: 30
        with:
          detached: true
          limit-access-to-actor: false  # Allow connection without pre-registered SSH keys
      
      - name: Fail the workflow if tests failed
        if: steps.integration_tests.outcome == 'failure'
        run: exit 1

      - name: Get Repository Name
        run:   echo "REPOSITORY_NAME=`echo "$GITHUB_REPOSITORY" | awk -F / '{print $2}' | sed -e "s/:refs//"`" >> $GITHUB_ENV
        shell: bash

      - name: Get version tag
        # run: echo "##[set-output name=version;]$(echo `git ls-remote https://${{ secrets.ORG_PAT_GITHUB }}@github.com/atlanhq/${REPOSITORY_NAME}.git ${{ env.BRANCH_NAME }} | awk '{ print $1}' | cut -c1-7`)abcd"
        run: |
          echo "VERSION=$(git ls-remote https://${{ secrets.ORG_PAT_GITHUB }}@github.com/atlanhq/${REPOSITORY_NAME}.git ${{ env.BRANCH_NAME }} | awk '{ print $1}' | cut -c1-7 | head -n 1)abcd"
          echo "VERSION=$(git ls-remote https://${{ secrets.ORG_PAT_GITHUB }}@github.com/atlanhq/${REPOSITORY_NAME}.git ${{ env.BRANCH_NAME }} | awk '{ print $1}' | cut -c1-7 | tr -d '[:space:]')abcd"
          echo "VERSION=$(git ls-remote https://${{ secrets.ORG_PAT_GITHUB }}@github.com/atlanhq/${REPOSITORY_NAME}.git ${{ env.BRANCH_NAME }} | awk '{ print $1}' | cut -c1-7 | tr -d '[:space:]')abcd" >> $GITHUB_ENV

      - name: Get commit ID
        run: echo "COMMIT_ID=$(echo ${GITHUB_SHA} | cut -c1-7)abcd" >> $GITHUB_ENV

      # QEMU is required to build arm from a non-arm build machine
      - name: Set up QEMU
        id: qemu
        uses: docker/setup-qemu-action@v3
        with:
          image: tonistiigi/binfmt:qemu-v7.0.0-28
          platforms: arm64

      - name: Set up Buildx
        id: buildx
        uses: docker/setup-buildx-action@v1

      - name: Login to GitHub Registry
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: $GITHUB_ACTOR
          password: ${{ secrets.ORG_PAT_GITHUB }}

      - name: Build and push
        id: docker_build
        uses: docker/build-push-action@v3
        with:
          platforms: linux/amd64,linux/arm64
          context: .
          file: ./Dockerfile
          no-cache: true
          sbom: true
          provenance: true
          push: true
          tags: |
            ghcr.io/atlanhq/${{ github.event.repository.name }}-${{ env.BRANCH_NAME }}:latest
            ghcr.io/atlanhq/${{ github.event.repository.name }}-${{ env.BRANCH_NAME }}:${{ env.COMMIT_ID }}

      - name: Check Image Manifest
        run: docker buildx imagetools inspect --raw ghcr.io/atlanhq/${{ github.event.repository.name }}-${{ env.BRANCH_NAME }}:${{ env.COMMIT_ID }}

      - name: Scan Image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'ubuntu:18.04'
          vuln-type: 'os,library'
          format: 'sarif'
          output: 'trivy-image-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2.1.33
        with:
          sarif_file: 'trivy-image-results.sarif'