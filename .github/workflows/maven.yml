
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Java CI with Maven

on:
  push:
    branches:
      - beta
      - master
      - staging
      - lite_master
      - alcon-v2-418
      - ms-546
    paths-ignore:
      - '.claude/**'
      - '.cursor/**'
      - '.github/**'
      - 'docs/**'
      - 'local-dev/**'
      - 'README.txt'
      - 'README.md'

jobs:
  # Detect what changed to optimize workflow execution
  # This dramatically speeds up helm-only changes by skipping the 20+ minute build job
  changes:
    runs-on: ubuntu-latest
    outputs:
      non_helm: ${{ steps.filter.outputs.non_helm }}
      helm: ${{ steps.filter.outputs.helm }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch all history for accurate comparisons

      - uses: dorny/paths-filter@v2
        id: filter
        with:
          # Compare against the previous commit on this branch (not master)
          # This way we only detect changes in the current push
          base: ${{ github.event.before }}
          filters: |
            helm:
              - 'helm/**'
            non_helm:
              - '!helm/**'

  helm-lint:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # Application charts
          - chart: atlas
            path: helm/atlas
            requires_app_version: true
          - chart: atlas-read
            path: helm/atlas-read
            requires_app_version: true
          # Atlas infrastructure charts
          - chart: cassandra
            path: helm/atlas/charts/cassandra
            requires_app_version: false
          - chart: elasticsearch
            path: helm/atlas/charts/elasticsearch
            requires_app_version: false
          - chart: logstash
            path: helm/atlas/charts/logstash
            requires_app_version: false
          # Atlas-Read infrastructure charts
          - chart: cassandra-online-dc
            path: helm/atlas-read/charts/cassandra-online-dc
            requires_app_version: false
          - chart: elasticsearch-read
            path: helm/atlas-read/charts/elasticsearch-read
            requires_app_version: false
          - chart: elasticsearch-exporter-read
            path: helm/atlas-read/charts/elasticsearch-exporter-read
            requires_app_version: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.12.0'
      
      - name: Update helm dependencies
        if: matrix.chart == 'atlas' || matrix.chart == 'atlas-read'
        run: |
          cd ${{ matrix.path }}
          helm dependency update
          
          echo "Chart dependencies:"
          ls -la charts/
      
      - name: Lint helm chart
        run: |
          helm lint ${{ matrix.path }}/
          echo "✅ ${{ matrix.chart }} chart lint passed!"
      
      - name: Validate Chart.yaml
        run: |
          # Check for required fields
          if ! grep -q "^version:" ${{ matrix.path }}/Chart.yaml; then
            echo "❌ Error: version field missing in Chart.yaml"
            exit 1
          fi
          
          # appVersion is only required for application charts (atlas, atlas-read)
          if [[ "${{ matrix.requires_app_version }}" == "true" ]]; then
            if ! grep -q "^appVersion:" ${{ matrix.path }}/Chart.yaml; then
              echo "❌ Error: appVersion field missing in Chart.yaml for application chart"
              exit 1
            fi
          fi
          
          echo "✅ Chart.yaml validation passed for ${{ matrix.chart }}!"

  build:
    needs: [helm-lint, changes]
    # Skip build ONLY if changes are exclusively in helm/**
    # Run build for: any changes outside helm/ (future-proof)
    if: needs.changes.outputs.non_helm == 'true'
    runs-on: ubuntu-latest

    steps:
      # ============================================
      # AGGRESSIVE DISK CLEANUP - RUN FIRST
      # GitHub runners have ~14GB free but pre-installed
      # software consumes most of it. This frees ~30GB.
      # ============================================
      - name: Free up disk space (aggressive)
        run: |
          echo "=========================================="
          echo "INITIAL DISK SPACE"
          echo "=========================================="
          df -h / | tail -1
          
          echo ""
          echo "=========================================="
          echo "REMOVING PRE-INSTALLED SOFTWARE"
          echo "=========================================="
          
          # Remove Android SDK (~12GB)
          sudo rm -rf /usr/local/lib/android || true
          
          # Remove .NET (~2GB)
          sudo rm -rf /usr/share/dotnet || true
          
          # Remove Haskell/GHC (~5GB)
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /usr/local/.ghcup || true
          
          # Remove Swift (~2GB)
          sudo rm -rf /usr/share/swift || true
          
          # Remove CodeQL (~1GB)
          sudo rm -rf /opt/hostedtoolcache/CodeQL || true
          
          # Remove Go (~1GB)
          sudo rm -rf /opt/hostedtoolcache/go || true
          
          # Remove Python versions we don't need
          sudo rm -rf /opt/hostedtoolcache/Python/3.7.* || true
          sudo rm -rf /opt/hostedtoolcache/Python/3.8.* || true
          sudo rm -rf /opt/hostedtoolcache/Python/3.9.* || true
          
          # Remove Ruby
          sudo rm -rf /opt/hostedtoolcache/Ruby || true
          
          # Remove Node.js versions
          sudo rm -rf /opt/hostedtoolcache/node || true
          
          # Remove PyPy
          sudo rm -rf /opt/hostedtoolcache/PyPy || true
          
          # Remove large apt packages
          sudo apt-get remove -y '^dotnet-.*' '^llvm-.*' 'php.*' '^mongodb-.*' '^mysql-.*' azure-cli google-cloud-cli google-chrome-stable firefox powershell mono-devel libgl1-mesa-dri --fix-missing 2>/dev/null || true
          sudo apt-get autoremove -y || true
          sudo apt-get clean || true
          
          # Clean apt cache
          sudo rm -rf /var/lib/apt/lists/* || true
          sudo rm -rf /var/cache/apt/archives/* || true
          
          # Remove swap file (~4GB)
          sudo swapoff -a || true
          sudo rm -f /swapfile || true
          sudo rm -f /mnt/swapfile || true
          
          # Clean Docker (just in case there are pre-pulled images)
          docker system prune -af --volumes 2>/dev/null || true
          
          # Remove other large directories
          sudo rm -rf /usr/local/share/boost || true
          sudo rm -rf /usr/local/graalvm || true
          sudo rm -rf /usr/local/julia* || true
          
          echo ""
          echo "=========================================="
          echo "DISK SPACE AFTER CLEANUP"
          echo "=========================================="
          df -h / | tail -1
          
          # Verify we have enough space
          AVAILABLE_GB=$(df -BG / | tail -1 | awk '{print $4}' | sed 's/G//')
          echo "Available space: ${AVAILABLE_GB}GB"
          
          if [ "$AVAILABLE_GB" -lt 25 ]; then
            echo "⚠️  Warning: Less than 25GB available, build might fail"
          else
            echo "✅ Sufficient disk space available (${AVAILABLE_GB}GB)"
          fi

      - uses: actions/checkout@v3

      # Set up Docker
      - name: Set up Docker
        uses: docker/setup-buildx-action@v2
        with:
          driver-opts: image=moby/buildkit:master
          install: true

      - name: Set up JDK 17
        uses: actions/setup-java@v1
        with:
          java-version: 17

      - name: Print JDK version
        run: java -version

      # Verify Docker is available
      - name: Verify Docker
        run: |
         docker --version
         docker info

      - name: Cache Maven packages
        uses: actions/cache@v3
        id: maven-cache
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Check Maven cache status
        run: |
          if [ "${{ steps.maven-cache.outputs.cache-hit }}" == "true" ]; then
            echo "✅ Maven cache hit - dependencies will be reused"
          else
            echo "ℹ️  Maven cache miss - will download dependencies"
          fi

      - name: Get branch name
        run: |
          # Convert branch name to lowercase for Docker compatibility
          BRANCH_NAME=$(echo "${GITHUB_REF#refs/heads/}" | tr '[:upper:]' '[:lower:]')
          echo "BRANCH_NAME=${BRANCH_NAME}" >> $GITHUB_ENV
          echo "BRANCH_NAME=${BRANCH_NAME}"

      - name: Create Maven Settings
        uses: s4u/maven-settings-action@v2.8.0
        with:
          servers: |
            [{
                "id": "github",
                "username": "atlan-ci",
                "password": "${{ secrets.ORG_PAT_GITHUB }}"
            }]

      - name: Build with Maven
        run: |
          echo "build without dashboard"
          chmod +x ./build.sh && ./build.sh

      - name: Clean up after Maven build
        run: |
          echo "=========================================="
          echo "POST-BUILD CLEANUP"
          echo "=========================================="
          df -h / | tail -1
          
          # Remove Maven build intermediates we don't need
          echo "Cleaning Maven build intermediates..."
          find . -type d -name "generated-sources" -exec rm -rf {} + 2>/dev/null || true
          find . -type d -name "generated-test-sources" -exec rm -rf {} + 2>/dev/null || true
          find . -type d -name "maven-status" -exec rm -rf {} + 2>/dev/null || true
          find . -type d -name "test-classes" -exec rm -rf {} + 2>/dev/null || true
          
          # Remove duplicate JARs from distro if they exist in webapp
          echo "Removing duplicate artifacts..."
          rm -rf distro/target/apache-atlas-*-bin.tar.gz 2>/dev/null || true
          rm -rf distro/target/apache-atlas-*-sources.tar.gz 2>/dev/null || true
          
          # Clean temp files
          sudo rm -rf /tmp/* 2>/dev/null || true
          
          echo ""
          echo "Disk space after post-build cleanup:"
          df -h / | tail -1

      - name: Verify disk space for tests
        if: github.ref_name == 'beta' || github.ref_name == 'staging' || github.ref_name == 'master'
        run: |
          echo "=========================================="
          echo "DISK SPACE CHECK BEFORE TESTS"
          echo "=========================================="
          
          DISK_USAGE=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
          AVAILABLE_GB=$(df -BG / | tail -1 | awk '{print $4}' | sed 's/G//')
          
          echo "Current disk usage: ${DISK_USAGE}%"
          echo "Available space: ${AVAILABLE_GB}GB"
          
          # Fail if less than 10GB available (ES needs space for indices)
          if [ "$AVAILABLE_GB" -lt 10 ]; then
            echo "❌ ERROR: Insufficient disk space (${AVAILABLE_GB}GB available)"
            echo "Tests require at least 10GB free space"
            echo "Elasticsearch will fail with high disk watermark errors"
            exit 1
          else
            echo "✅ Sufficient disk space available (${AVAILABLE_GB}GB)"
          fi

      - name: Run Integration Tests
        id: integration_tests
        if: github.ref_name == 'beta' || github.ref_name == 'staging' || github.ref_name == 'master'
        continue-on-error: true
        env:
          # Configure Testcontainers for GitHub Actions
          TESTCONTAINERS_RYUK_DISABLED: true
          TESTCONTAINERS_CHECKS_DISABLE: true
          DOCKER_HOST: unix:///var/run/docker.sock
        run: |
          echo "Running integration tests..."
          chmod +x ./run-integration-tests.sh && ./run-integration-tests.sh --skip-build

      - name: Upload container logs as artifact
        if: always() && steps.integration_tests.outcome != 'skipped'
        uses: actions/upload-artifact@v4
        with:
          name: container-logs-${{ github.run_id }}
          path: target/test-logs/
          retention-days: 5

      - name: Fail the workflow if tests failed
        if: steps.integration_tests.outcome == 'failure'
        run: exit 1

      - name: Clean up after integration tests
        if: always() && steps.integration_tests.outcome != 'skipped'
        run: |
          echo "=========================================="
          echo "POST-TEST CLEANUP"
          echo "=========================================="
          
          # Stop and remove all containers
          echo "Stopping and removing containers..."
          docker ps -a -q | xargs -r docker rm -f 2>/dev/null || true
          
          # Remove all Docker data aggressively
          echo "Cleaning Docker system..."
          docker system prune -af --volumes 2>/dev/null || true
          
          # Don't remove Maven cache - it's cached separately and speeds up builds
          
          # Clean test artifacts
          echo "Cleaning test artifacts..."
          rm -rf webapp/target/surefire-reports/ || true
          rm -rf test-debug-logs/ || true
          # Keep target/test-logs for artifact upload
          
          # Clean temp files
          echo "Cleaning temp files..."
          sudo rm -rf /tmp/* 2>/dev/null || true
          
          echo ""
          echo "Disk space after cleanup:"
          df -h / | tail -1

      - name: Pre-Docker build cleanup
        run: |
          echo "=========================================="
          echo "PRE-DOCKER BUILD CLEANUP"
          echo "=========================================="
          df -h / | tail -1
          
          # Remove test artifacts we no longer need
          rm -rf target/test-logs/ 2>/dev/null || true
          rm -rf webapp/target/surefire-reports/ 2>/dev/null || true
          
          # Remove Maven cache for atlas (we've already built, docker will use the JARs)
          rm -rf ~/.m2/repository/org/apache/atlas/ 2>/dev/null || true
          
          # Clean any remaining Docker artifacts
          docker system prune -af 2>/dev/null || true
          
          echo ""
          echo "Disk space after pre-Docker cleanup:"
          df -h / | tail -1

      - name: Get Repository Name
        run:   echo "REPOSITORY_NAME=`echo "$GITHUB_REPOSITORY" | awk -F / '{print $2}' | sed -e "s/:refs//"`" >> $GITHUB_ENV
        shell: bash

      - name: Get version tag
        # run: echo "##[set-output name=version;]$(echo `git ls-remote https://${{ secrets.ORG_PAT_GITHUB }}@github.com/atlanhq/${REPOSITORY_NAME}.git ${{ env.BRANCH_NAME }} | awk '{ print $1}' | cut -c1-7`)abcd"
        run: |
          echo "VERSION=$(git ls-remote https://${{ secrets.ORG_PAT_GITHUB }}@github.com/atlanhq/${REPOSITORY_NAME}.git ${{ env.BRANCH_NAME }} | awk '{ print $1}' | cut -c1-7 | head -n 1)abcd"
          echo "VERSION=$(git ls-remote https://${{ secrets.ORG_PAT_GITHUB }}@github.com/atlanhq/${REPOSITORY_NAME}.git ${{ env.BRANCH_NAME }} | awk '{ print $1}' | cut -c1-7 | tr -d '[:space:]')abcd"
          echo "VERSION=$(git ls-remote https://${{ secrets.ORG_PAT_GITHUB }}@github.com/atlanhq/${REPOSITORY_NAME}.git ${{ env.BRANCH_NAME }} | awk '{ print $1}' | cut -c1-7 | tr -d '[:space:]')abcd" >> $GITHUB_ENV

      - name: Get commit ID
        run: echo "COMMIT_ID=$(echo ${GITHUB_SHA} | cut -c1-7)abcd" >> $GITHUB_ENV

      # QEMU is required to build arm from a non-arm build machine
      - name: Set up QEMU
        id: qemu
        uses: docker/setup-qemu-action@v3
        with:
          image: tonistiigi/binfmt:qemu-v7.0.0-28
          platforms: arm64

      - name: Set up Buildx
        id: buildx
        uses: docker/setup-buildx-action@v1

      - name: Login to GitHub Registry
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: $GITHUB_ACTOR
          password: ${{ secrets.ORG_PAT_GITHUB }}

      - name: Build and push
        id: docker_build
        uses: docker/build-push-action@v3
        with:
          platforms: linux/amd64,linux/arm64
          context: .
          file: ./Dockerfile
          no-cache: true
          sbom: true
          provenance: true
          push: true
          tags: |
            ghcr.io/atlanhq/${{ github.event.repository.name }}-${{ env.BRANCH_NAME }}:latest
            ghcr.io/atlanhq/${{ github.event.repository.name }}-${{ env.BRANCH_NAME }}:${{ env.COMMIT_ID }}

      - name: Check Image Manifest
        run: docker buildx imagetools inspect --raw ghcr.io/atlanhq/${{ github.event.repository.name }}-${{ env.BRANCH_NAME }}:${{ env.COMMIT_ID }}

      - name: Scan Image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'ghcr.io/atlanhq/${{ github.event.repository.name }}-${{ env.BRANCH_NAME }}:${{ env.COMMIT_ID }}'
          vuln-type: 'os,library'
          format: 'sarif'
          output: 'trivy-image-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2.1.33
        with:
          sarif_file: 'trivy-image-results.sarif'