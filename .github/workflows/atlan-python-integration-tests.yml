#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

name: Atlan Python Integration Tests

on:
  push:
    branches:
      - alpha
      - beta
      - development
      - master
      - staging
  pull_request:
    branches:
      - master
      - development
      - staging
  workflow_dispatch:
    inputs:
      atlan_python_branch:
        description: 'Branch of atlan-python to test against'
        required: false
        default: 'main'
        type: string
      test_pattern:
        description: 'Test pattern to run (e.g., test_integration). If not provided, runs admin_test.py and adls_asset_test.py'
        required: false
        type: string

env:
  ATLAN_BASE_URL: ${{ secrets.ATLAN_BASE_URL }}
  ATLAN_API_KEY: ${{ secrets.ATLAN_API_KEY }}

jobs:
  integration-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    # Run different test files in parallel, each file executes sequentially
    strategy:
      matrix:
        test_file:
          - tests/integration/admin_test.py
          - tests/integration/connection_test.py
          - tests/integration/glossary_test.py
          - tests/integration/persona_test.py
      fail-fast: false

    steps:
      - name: Checkout atlan-python repository
        uses: actions/checkout@v4
        with:
          repository: atlanhq/atlan-python
          ref: ${{ github.event.inputs.atlan_python_branch || 'main' }}
          token: ${{ secrets.ORG_PAT_GITHUB }}
          path: atlan-python

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Cache Python packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-3.11-${{ hashFiles('atlan-python/**/requirements*.txt', 'atlan-python/**/pyproject.toml', 'atlan-python/**/setup.py') }}
          restore-keys: |
            ${{ runner.os }}-pip-3.11-
            ${{ runner.os }}-pip-

      - name: Verify Atlan API connectivity
        env:
          ATLAN_BASE_URL: ${{ secrets.ATLAN_BASE_URL }}
          ATLAN_API_KEY: ${{ secrets.ATLAN_API_KEY }}
        run: |
          echo "Verifying Atlan API connectivity..."
          if [ -z "$ATLAN_BASE_URL" ] || [ -z "$ATLAN_API_KEY" ]; then
            echo "❌ ATLAN_BASE_URL or ATLAN_API_KEY secrets not configured"
            exit 1
          fi
          
          # Test API connectivity (adjust endpoint as needed for atlan-python)
          curl -H "Authorization: Bearer $ATLAN_API_KEY" \
               -H "Content-Type: application/json" \
               "$ATLAN_BASE_URL/api/meta" || exit 1
          echo "✅ Atlan API is accessible"

      - name: Install atlan-python dependencies
        working-directory: atlan-python
        run: |
          python -m pip install --upgrade pip
          
          # Install from requirements.txt if it exists
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          
          # Install from pyproject.toml if it exists
          if [ -f pyproject.toml ]; then
            pip install -e .
          elif [ -f setup.py ]; then
            pip install -e .
          fi
          
          # Install test dependencies
          if [ -f requirements-test.txt ]; then
            pip install -r requirements-test.txt
          elif [ -f test-requirements.txt ]; then
            pip install -r test-requirements.txt
          fi
          
          # Install common test packages with specific versions
          pip install pytest pytest-cov pytest-xdist pytest-vcr pytest-order requests "vcrpy>=6.0.0,<7.0.0"

      - name: Fix pytest_plugins configuration
        working-directory: atlan-python
        run: |
          echo "Fixing pytest_plugins configuration..."
          
          # Handle pytest_plugins multi-line definition properly
          if [ -f "tests/integration/conftest.py" ] && grep -q "pytest_plugins" "tests/integration/conftest.py"; then
            echo "Found pytest_plugins in tests/integration/conftest.py, fixing it"
            
            # Use awk to comment out the entire pytest_plugins block
            awk '
            /^pytest_plugins/ { in_block=1; print "#" $0; next }
            in_block && /^\s*"/ { print "#" $0; next }
            in_block && /^\s*\]/ { print "#" $0; in_block=0; next }
            { print }
            ' "tests/integration/conftest.py" > temp_conftest.py && mv temp_conftest.py "tests/integration/conftest.py"
            
            echo "✅ Fixed pytest_plugins configuration while preserving fixtures"
          else
            echo "No pytest_plugins issue found"
          fi
          
          # Add missing client fixture if it doesn't exist
          if ! grep -q "def client" "tests/integration/conftest.py"; then
            echo "Adding missing client fixture..."
            echo "" >> "tests/integration/conftest.py"
            echo "import pytest" >> "tests/integration/conftest.py"
            echo "from pyatlan.client.atlan import AtlanClient" >> "tests/integration/conftest.py"
            echo "" >> "tests/integration/conftest.py"
            echo "@pytest.fixture(scope=\"module\")" >> "tests/integration/conftest.py"
            echo "def client() -> AtlanClient:" >> "tests/integration/conftest.py"
            echo "    \"\"\"Provide an AtlanClient instance for integration tests.\"\"\"" >> "tests/integration/conftest.py"
            echo "    return AtlanClient()" >> "tests/integration/conftest.py"
            echo "✅ Added client fixture to conftest.py"
          fi

      - name: Run Integration Tests
        working-directory: atlan-python
        env:
          ATLAN_BASE_URL: ${{ env.ATLAN_BASE_URL }}
          ATLAN_API_KEY: ${{ env.ATLAN_API_KEY }}
          PYTHONPATH: ${{ github.workspace }}/atlan-python
        run: |
          echo "Running integration tests for ${{ matrix.test_file }}..."
          
          # If a custom test pattern is provided, only one matrix job should run it to avoid duplicates
          if [ -n "${{ github.event.inputs.test_pattern }}" ]; then
            TEST_PATTERN="${{ github.event.inputs.test_pattern }}"
            if [ "${{ matrix.test_file }}" != "tests/integration/admin_test.py" ]; then
              echo "Custom pattern provided; skipping on ${{ matrix.test_file }} to avoid duplicate runs."
              exit 0
            fi
            echo "Running tests with custom pattern: $TEST_PATTERN"
            python -m pytest -v -k "$TEST_PATTERN" --tb=short --maxfail=5
          else
            # Run a single integration test file per job (sequential within file)
            echo "Running tests in file: ${{ matrix.test_file }} sequentially"
            python -m pytest -v tests/integration/admin_test.py tests/integration/connection_test.py tests/integration/glossary_test.py tests/integration/persona_test.py --tb=short --maxfail=5
            #python -m pytest -v ${{ matrix.test_file }} --tb=short --maxfail=5
          fi

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ replace(matrix.test_file, '/', '-') }}
          if-no-files-found: ignore
          path: |
            atlan-python/test-results/
            atlan-python/tests/test-results/
            atlan-python/coverage.xml
            atlan-python/pytest.xml



  notify-results:
    needs: integration-tests
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Notify on success
        if: needs.integration-tests.result == 'success'
        run: |
          echo "✅ All integration tests passed successfully!"

      - name: Notify on failure
        if: needs.integration-tests.result == 'failure'
        run: |
          echo "❌ Integration tests failed. Check the logs for details."
          exit 1 