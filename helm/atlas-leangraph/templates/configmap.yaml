{{- if .Values.global.leangraph.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: atlas-leangraph-config
  namespace: {{ .Values.Namespace }}
  labels:
    app: {{ template "name" . }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
data:
  atlas-application.properties: |
    #
    # Licensed to the Apache Software Foundation (ASF) under one
    # or more contributor license agreements.  See the NOTICE file
    # distributed with this work for additional information
    # regarding copyright ownership.  The ASF licenses this file
    # to you under the Apache License, Version 2.0 (the
    # "License"); you may not use this file except in compliance
    # with the License.  You may obtain a copy of the License at
    #
    #     http://www.apache.org/licenses/LICENSE-2.0
    #
    # Unless required by applicable law or agreed to in writing, software
    # distributed under the License is distributed on an "AS IS" BASIS,
    # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    # See the License for the specific language governing permissions and
    # limitations under the License.
    #

    #########  Graph Database Configs  #########

    atlas.graph.storage.backend=cql
    atlas.graph.storage.hostname={{ .Chart.Name }}-cassandra
    atlas.graph.storage.cql.keyspace={{ .Values.atlas.leangraph.cql_keyspace }}
    atlas.graph.storage.cql.replication-factor={{ .Values.cassandra.config.cluster_size }}
    atlas.graph.storage.clustername={{ .Values.cassandra.config.cluster_name  }}
    atlas.graph.storage.port={{ .Values.cassandra.config.ports.cql }}
    atlas.graph.query.fast-property=true
    atlas.graph.query.batch=true
    atlas.graph.storage.cql.remote-core-connections-per-host=5
    atlas.graph.storage.cql.remote-max-connections-per-host=5
    atlas.graph.storage.cql.request-timeout=5000
    atlas.graph.graph.replace-instance-if-exists=true

    atlas.graph.tag.table.name={{ .Values.atlas.leangraph.tag_table_name }}
    atlas.graph.propagated.tag.table.name={{ .Values.atlas.leangraph.propagated_tag_table_name }}
    atlas.graph.new.keyspace={{ .Values.atlas.leangraph.new_keyspace }}

    atlas.DeleteHandlerV1.impl=org.apache.atlas.repository.store.graph.v1.SoftDeleteHandlerV1

    atlas.rest.enable.delete.type.override=true
    
    atlas.EntityAuditRepository.impl=org.apache.atlas.repository.audit.NoopEntityAuditRepository
    atlas.EntityAuditRepository.keyspace=atlas_audit
    atlas.EntityAuditRepository.replicationFactor={{ .Values.cassandra.config.cluster_size }}
    atlas.entity.audit.differential=true
    atlas.EntityAuditRepositorySearch.impl=org.apache.atlas.repository.audit.ESBasedAuditRepository

    ######### Atlas Entity Attribute configs #########
    atlas.entities.attribute.allowed.large.attributes={{ .Values.atlas.config.entities_allowed_large_attributes }}

    # Graph Search Index
    atlas.graph.index.search.backend=elasticsearch
    atlas.graph.index.search.hostname=atlas-elasticsearch-master:9200
    atlas.graph.index.search.elasticsearch.client-only=true
    atlas.graph.index.search.elasticsearch.retry_on_conflict=5
    atlas.graph.index.search.max-result-set-size=1000
    atlas.graph.index.search.index-name={{ .Values.atlas.leangraph.index_name }}
    atlas.index.audit.elasticsearch.total_field_limit={{ .Values.atlas.index.audit_index_field_limit }}
    atlas.index.audit.elasticsearch.refresh_interval={{ .Values.atlas.index.audit_index_refresh_interval }}

    #########  Notification Configs  #########
    atlas.kafka.bootstrap.servers=kafka-0.kafka-headless.kafka.svc.cluster.local:9092,kafka-1.kafka-headless.kafka.svc.cluster.local:9092,kafka-2.kafka-headless.kafka.svc.cluster.local:9092
    
    atlas.kafka.zookeeper.session.timeout.ms=60000
    atlas.kafka.zookeeper.connection.timeout.ms=30000
    atlas.kafka.zookeeper.sync.time.ms=20
    atlas.kafka.zookeeper.connect=zookeeper-0.zookeeper-headless.atlas.svc.cluster.local:2181,zookeeper-1.zookeeper-headless.atlas.svc.cluster.local:2181,zookeeper-2.zookeeper-headless.atlas.svc.cluster.local:2181

    atlas.kafka.auto.commit.interval.ms=1000
    atlas.kafka.hook.group.id=atlas-leangraph
    atlas.kafka.enable.auto.commit=false
    atlas.kafka.auto.offset.reset=earliest
    atlas.kafka.session.timeout.ms=30000
    atlas.kafka.offsets.topic.replication.factor=2
    atlas.kafka.poll.timeout.ms=2000

    atlas.notification.create.topics=true
    atlas.notification.replicas=3
    atlas.notification.topics=ATLAS_HOOK,ATLAS_ENTITIES
    atlas.notification.log.failed.messages=true
    atlas.notification.failed.messages.filename=atlas_hook_failed_messages.log
    atlas.notification.consumer.retry.interval=3000
    atlas.notification.hook.retry.interval=3000

    #########  Security Properties  #########

    atlas.enableTLS=false

    atlas.authentication.method.kerberos=false
    atlas.authentication.method.file=false

    atlas.authentication.method.keycloak=true
    atlas.authentication.method.keycloak.file=${sys:atlas.home}/conf/keycloak.json
    atlas.authentication.method.keycloak.ugi-groups=false
    atlas.authentication.method.keycloak.groups_claim=groups

    atlas.authentication.method.ldap.type=none

    atlas.authentication.method.file.filename=${sys:atlas.home}/conf/users-credentials.properties

    #########  Server Properties  #########
    atlas.rest.address=http://localhost:21000

    #########  High Availability Configuration ########
    {{- if eq .Values.atlas_ha false }}
    atlas.server.ha.enabled=false
    {{- else if eq .Values.atlas_ha true }}
    atlas.server.ha.enabled=true
    {{- else }}
    atlas.server.ha.enabled=false
    {{- end }}
    atlas.server.type.cache-refresher=http://cinv.atlas.svc.cluster.local:5000/cinv
    atlas.server.type.cache-refresher-health=http://cinv.atlas.svc.cluster.local:5000/health
    atlas.server.ids=id1,id2
    atlas.server.address.id1=atlas-leangraph-0.atlas-leangraph-service.atlas.svc.cluster.local:21000
    atlas.server.address.id2=atlas-leangraph-1.atlas-leangraph-service.atlas.svc.cluster.local:21000
    atlas.server.ha.zookeeper.connect=zookeeper-0.zookeeper-headless.atlas.svc.cluster.local:2181,zookeeper-1.zookeeper-headless.atlas.svc.cluster.local:2181,zookeeper-2.zookeeper-headless.atlas.svc.cluster.local:2181
    atlas.server.ha.zookeeper.retry.sleeptime.ms=10000
    atlas.server.ha.zookeeper.num.retries=18
    atlas.server.ha.zookeeper.session.timeout.ms=20000

    ######### Atlas Authorization #########
    {{- if eq .Values.atlas_auth true }}
    atlas.authorizer.impl=atlas
    {{- else }}
    atlas.authorizer.impl=org.apache.ranger.authorization.atlas.authorizer.RangerAtlasAuthorizer
    {{- end }}

    atlas.authorizer.enable.delta_based_refresh={{ .Values.atlas.authorizer.enable_delta_based_refresh }}
    atlas.authorizer.enable.abac={{ .Values.atlas.authorizer.enable_abac }}

    ######### Atlas User service #########
    atlas.user-service-url=http://heracles-service.heracles.svc.cluster.local

    #########  Performance Configs  #########
    atlas.graph.storage.lock.retries=5
    
    #########  Redis Cache Configs  #########
    {{- if eq .Values.atlas.cache.enabled false }}
    atlas.graph.cache.db-cache=false
    {{- else if eq .Values.atlas.cache.enabled true }}
    atlas.graph.cache.db-cache=true
    atlas.graph.metrics.merge-stores=false
    atlas.graph.cache.cache-type=redis
    atlas.graph.cache.db-cache-expiry-time=86400000
    atlas.graph.cache.cache-keyspace-prefix=atlas-leangraph
    atlas.graph.cache.redis-db-id=1
    atlas.graph.cache.redis-client-name=atlas-leangraph
    atlas.graph.cache.redis-cache-size=100000
    atlas.graph.cache.redis-cache-server-mode=sentinel
    atlas.graph.cache.redis-cache-server-url=redis://{{ .Values.atlas.redis.host }}:{{ .Values.atlas.redis.port }}
    atlas.graph.cache.redis-cache-sentinel-urls={{ .Values.atlas.redis.sentinel_urls }}
    atlas.graph.cache.redis-cache-lock-watchdog-ms=300000
    atlas.graph.cache.redis-cache-username={{ .Values.atlas.redis.username }}
    atlas.graph.cache.redis-cache-password={{ .Values.atlas.redis.password }}
    atlas.graph.cache.redis-cache-mastername={{ .Values.atlas.redis.master_name }}
    atlas.graph.cache.redis-cache-connectTimeout=2000
    {{- end }}

    atlas.webserver.minthreads=40
    atlas.webserver.maxthreads=400
    atlas.webserver.keepalivetimesecs=30
    atlas.webserver.queuesize=200
    #########  CSRF Configs  #########
    atlas.rest-csrf.enabled=false

    ########## Slack Notification #############
    atlas.notifications.slackWebhook={{ .Values.atlas.notification.slackWebhook }}
    
    {{ if .Values.atlas.redis.enabled }}
    {{ printf "\n" }}
    ########## Add query metastore ###########
    atlan.cache.redis.host={{ .Values.atlas.redis.host }}
    atlan.cache.redis.port={{ .Values.atlas.redis.port }}
    atlan.cache.redis.password={{ .Values.atlas.redis.password }}
    atlas.cache.redis.maxConnections={{ .Values.atlas.redis.maxConnections }}
    atlas.cache.redis.timeout={{ .Values.atlas.redis.timeout }}
    atlan.EntityCacheListener.impl=org.apache.atlas.repository.cache.EntityCacheListenerV2
    atlan.QueryCacheRepository.impl=org.apache.atlas.repository.cache.AtlanQueryCacheRepository
    {{ printf "\n" }}
    
    {{ end }}
    

    ########## Atlas Monitoring #############
    
    atlas.graph.metrics.enabled = true
    atlas.graph.metrics.jmx.enabled = true
    atlas.statsd.enable = true

    
    ########## Atlas deferred-actions (background tasks) #############
    
    atlas.tasks.enabled = true


    ########## Ranger Credentials

    atlas.ranger.username = admin
    atlas.ranger.password = {{ .Values.atlas.ranger.RANGER_PASSWORD }}
    atlas.ranger.base.url = {{ .Values.atlas.ranger.RANGER_SERVICE_URL }}

    ####### Redis credentials #######
    atlas.redis.service.impl = org.apache.atlas.service.redis.RedisServiceImpl
    atlas.redis.url = redis://{{ .Values.atlas.redis.host }}:{{ .Values.atlas.redis.port }}
    atlas.redis.sentinel.urls = {{ .Values.atlas.redis.sentinel_urls }}
    atlas.redis.username = {{ .Values.atlas.redis.username }}
    atlas.redis.password = {{ .Values.atlas.redis.password }}
    atlas.redis.master_name = {{ .Values.atlas.redis.master_name }}
    atlas.redis.lock.wait_time.ms=15000
    atlas.redis.lock.watchdog_timeout.ms=600000

    atlas.jetty.request.buffer.size=32768
    
    atlas.metrics.uri_patterns=/api/(meta|atlas/v2)/glossary/terms/[^/]+/assignedEntities,/api/(meta|atlas/v2)/lineage/[^/]+,/api/(meta|atlas/v2)/lineage/list,/api/(meta|atlas/v2)/entity/accessors,/api/(meta|atlas/v2)/entity/auditSearch,/api/(meta|atlas/v2)/entity/bulk,/api/(meta|atlas/v2)/entity/bulk/setClassifications,/api/(meta|atlas/v2)/entity/bulk/uniqueAttribute,/api/(meta|atlas/v2)/entity/evaluator,/api/(meta|atlas/v2)/entity/guid/[^/]+,/api/(meta|atlas/v2)/entity/guid/[^/]+/businessmetadata,/api/(meta|atlas/v2)/entity/uniqueAttribute/type/[^/]+,/api/(meta|atlas/v2)/search/indexsearch,/api/(meta|atlas/v2)/entity/repairhaslineage,/api/(meta|atlas/v2)/types/typedef/name/[^/]+,/api/(meta|atlas/v2)/types/typedefs,/api/atlas/admin/metrics/prometheus,/api/atlas/admin/pushMetricsToStatsd,/api/atlas/v2/auth/download/policies/[^/]+,/api/atlas/v2/auth/download/roles/[^/]+,/api/atlas/v2/auth/download/users/[^/]+,/api/meta/entity/uniqueAttribute/type/[^/]+,/auth/admin/realms/[^/]+/admin-events,/auth/admin/realms/[^/]+/admin-events,/auth/admin/realms/[^/]+/events,/auth/admin/realms/[^/]+/events,/auth/admin/realms/[^/]+/groups,/auth/admin/realms/[^/]+/groups/[^/]+/role-mappings/realm,/auth/admin/realms/[^/]+/roles,/auth/admin/realms/[^/]+/roles-by-id/[^/]+,/auth/admin/realms/[^/]+/roles/[^/]+,/auth/admin/realms/[^/]+/roles/[^/]+/composites,/auth/admin/realms/[^/]+/roles/[^/]+/groups,/auth/admin/realms/[^/]+/roles/[^/]+/users,/auth/admin/realms/[^/]+/users,/auth/admin/realms/[^/]+/users/[^/]+/groups,/auth/admin/realms/[^/]+/users/[^/]+/role-mappings/realm,/auth/realms/[^/]+/protocol/openid-connect/token,/auth/realms/[^/]+/protocol/openid-connect/token/introspect,/users/mappings,/roles/mappings,/api/(meta|atlas/v2)/business-policy/[^/]+/unlink-business-policy,/api/(meta|atlas/v2)/business-policy/link-business-policy,/api/(meta|atlas/v2)/direct/search,/api/(meta|atlas/v2)/attribute/update
    
    atlas.metrics.method_level.enable=true
    atlas.metrics.method_patterns=policiesPrefetchFailed,mapVertexToAtlasEntityHeaderWithoutPrefetch,mapVertexToAtlasEntityHeaderWithPrefetch,processTermAssignments,elasticSearchQuery,mapVertexToAtlasEntityHeader,elasticQueryTimeout,getAllClassifications,scrubSearchResults,getAdjacentEdgesByLabel,preCreateOrUpdate,createOrUpdate,mapAttributes,graphCommit,getAtlasLineageInfo,getLineageInfoOnDemand,getLineageListInfoOnDemand,repairHasLineageForAssetGetById,repairHasLineageForAssetGetRelations,repairHasLineageForRequiredAsset,repairHasLineage,getRelationshipEdge,hasEdges,getEdgeBetweenVertices,removeHasLineageOnDelete,resetHasLineageOnInputOutputDelete,updateAssetHasLineageStatus,isAccessAllowed,findDuplicatePendingTasksV2
    {{ if .Values.atlas.janusgraph.atomic_mutation }}
    ### Atomic batch related configs ###
    atlas.graph.storage.cql.atomic-batch-mutate={{ .Values.atlas.janusgraph.atomic_mutation }}
    atlas.graph.storage.buffer-size={{ .Values.atlas.janusgraph.janusgraph_tx_buffer_size }}
    {{ end }}

    ######### Canary-Release #########
    atlas.canary.keycloak.token-introspection = true
    atlas.keycloak.introspection.use.cache = true

    ######### Atlas Maintenance Mode #########
    atlas.maintenance.mode={{ .Values.atlas.maintenanceMode }}

    ######### Atlas Indexsearch configs #########
    atlas.indexsearch.enable.api.limit={{ .Values.atlas.indexsearch.enable_api_limit }}
    atlas.indexsearch.query.size.max.limit={{ .Values.atlas.indexsearch.query_size_max_limit }}
    atlas.indexsearch.async.enable={{ .Values.atlas.indexsearch.enable_async }}
    atlas.indexsearch.async.search.keep.alive.time.in.seconds={{ .Values.atlas.indexsearch.request_timeout_in_secs }}
    atlas.indexsearch.enable.janus.optimization={{ .Values.atlas.indexsearch.enable_janus_optimization }}
    atlas.indexsearch.request.isolation.enable={{ .Values.atlas.indexsearch.enable_request_isolation }}
    atlas.indexsearch.enable.janus.optimization.for.relationship={{ .Values.atlas.indexsearch.enable_janus_optimization_for_relationship }}
    atlas.indexsearch.enable.janus.optimization.extended={{ .Values.atlas.indexsearch.enable_janus_optimization_extended }}
    atlas.indexsearch.enable.janus.optimization.for.classifications={{ .Values.atlas.indexsearch.enable_janus_optimization_for_classifications }}
    atlas.jg.super.vertex.min.edge.count={{ .Values.atlas.jg.super.vertex.min.edge.count }}
    
    ######### Atlas Bulk API configs #########
    atlas.bulk.api.max.entities.allowed={{ .Values.atlas.bulk.max_entities_allowed }}
    
    ######### Atlas Lineage configs #########
    atlas.lineage.optimised.calculation={{ .Values.atlas.lineage.optimised_calculation }}

    ######### Atlas Distributed Task configs #########
    atlas.distributed.task.enabled={{ .Values.atlas.distributed_task.enabled }}
    {{- if eq .Values.atlas.distributed_task.enabled true }}
    atlas.relationship.cleanup.supported.asset.types={{ .Values.atlas.distributed_task.cleanup_supported_asset_types }}
    atlas.relationship.cleanup.supported.relationship.labels={{ .Values.atlas.distributed_task.cleanup_supported_relationship_labels }}
    {{- end }}
    
    ######### Atlas Typedefs update configs #########
    atlas.types.update.async.enable={{ .Values.atlas.types_update.async_enable }}
    atlas.types.update.thread.count={{ .Values.atlas.types_update.thread_count }}

    ######### Atlas notification configs #########
    atlas.notification.differential.entity.changes.enabled={{ .Values.atlas.notification.differential_entity_changes_enabled }}
{{- end }}

