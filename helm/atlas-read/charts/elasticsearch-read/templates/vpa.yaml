{{- if and .Values.vpa.enabled (ne (.Values.global.Infra_Tier | default "") "Lite") }}
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: {{ template "elasticsearch.uname" . }}-vpa
  namespace: {{ .Values.Namespace }}
spec:
  targetRef:
    apiVersion: apps/v1
    kind: StatefulSet
    name: {{ template "elasticsearch.uname" . }}
  updatePolicy:
    updateMode: {{ .Values.vpa.updateMode | default "Off" | quote }}
    minReplicas: {{ max 2 (sub (int .Values.replicas) 1) }}
  resourcePolicy:
    containerPolicies:
    - containerName: "{{ template "elasticsearch.name" . }}"
      controlledResources:
        {{- $defaultControlledResources := list "cpu" "memory" }}
        {{- toYaml (.Values.vpa.controlledResources | default $defaultControlledResources) | nindent 8 }}
      controlledValues: {{ .Values.vpa.controlledValues | default "RequestsAndLimits" }}
      minAllowed:
        {{- $defaultMinAllowed := dict "cpu" "500m" "memory" "6Gi" }}
        {{- toYaml (.Values.vpa.minAllowed | default $defaultMinAllowed) | nindent 8 }}
      maxAllowed:
        {{- $defaultMaxAllowed := dict "cpu" "3000m" "memory" "8Gi" }}
        {{- toYaml (.Values.vpa.maxAllowed | default $defaultMaxAllowed) | nindent 8 }}
{{- end }}
